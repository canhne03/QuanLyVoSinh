{% extends "quantri.html" %}
{% block content %}
<h3>Quản lý Võ Sinh</h3>

<div class="mb-3 d-flex align-items-center gap-2 justify-content-end">
  <!-- Nút thêm mới -->
  <button type="button" class="btn btn-success btn-sm" data-bs-toggle="modal" data-bs-target="#addStudentModal">
    + Thêm Võ Sinh
  </button>

  <!-- Import Excel -->
  <form id="importForm" action="{{ url_for('admin_students_import') }}" method="POST" enctype="multipart/form-data" class="d-inline">
    <input type="file" name="file" id="fileInput" accept=".xlsx,.xls,.csv" style="display:none;" onchange="document.getElementById('importForm').submit();">
    <button type="button" class="btn btn-primary btn-sm" onclick="document.getElementById('fileInput').click();">Import Excel</button>
  </form>

  <!-- Export Excel -->
  <a href="{{ url_for('admin_students_export') }}" class="btn btn-warning btn-sm">Export Excel</a>
</div>

<!-- Modal Thêm Võ Sinh -->
<div class="modal fade" id="addStudentModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Thêm Võ Sinh</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Đóng"></button>
      </div>
      <div class="modal-body">
        <form id="addForm" action="{{ url_for('admin_students_add') }}" method="POST">
          <div class="mb-2">
            <label>Mã số:</label>
            <input type="text" name="vocotruyenid" class="form-control" required>
          </div>
          <div class="mb-2">
            <label>Họ và tên:</label>
            <input type="text" name="hovaten" class="form-control" required>
          </div>
          <div class="mb-2">
            <label>Năm sinh:</label>
            <input type="number" name="namsinh" class="form-control">
          </div>
          <div class="mb-2">
            <label>Giới tính:</label>
            <select name="gioitinh" class="form-control">
              <option value="">--Chọn--</option>
              <option value="Nam">Nam</option>
              <option value="Nữ">Nữ</option>
            </select>
          </div>

          <!-- Cấp bậc -->
          <div class="mb-2">
            <label for="capbac-add">Cấp bậc:</label>
            <select name="capbac" id="capbac-add"
                    class="form-control capbac-input" data-target="add">
              {% for i in range(1, 19) %}
                <option value="{{ i }}">Cấp {{ i }}</option>
              {% endfor %}
                <option value="Phong tặng">Phong tặng</option>
            </select>
          </div>

          <!-- Trình độ -->
          <div class="mb-2">
            <label>Trình độ:</label>
            <input type="text" class="form-control trinhdo-display"
                   id="trinhdo-add" value="" readonly>
          </div>

          <!-- Màu đai -->
          <div class="mb-2">
            <label>Màu đai:</label><br>
            <img id="maudai-add" src="{{ url_for('static', filename='default.jpg') }}"
                 style="width:60px; height:auto;">
          </div>

          <!-- Hidden input để gửi về server -->
          <input type="hidden" name="trinhdo" id="hidden-trinhdo-add" value="">
          <input type="hidden" name="maudai" id="hidden-maudai-add" value="">

          <div class="mb-2">
            <label>Đơn vị:</label>
            <input type="text" name="donvi" class="form-control">
          </div>
          <div class="mb-2">
            <label>Thành tích:</label>
            <input type="text" name="thanhtich" class="form-control">
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary btn-sm" data-bs-dismiss="modal">Hủy</button>
        <button type="submit" class="btn btn-success btn-sm" form="addForm">Thêm</button>
      </div>
    </div>
  </div>
</div>

<hr>

<!-- ==== Danh sách võ sinh ==== -->
<h5>Danh sách Võ Sinh</h5>
<table class="table table-bordered table-striped mt-2">
  <thead>
    <tr>
      <th>Mã số</th>
      <th>Họ tên</th>
      <th>Năm sinh</th>
      <th>Giới tính</th>
      <th>Cấp bậc</th>
      <th>Trình độ</th>
      <th>Màu đai</th>
      <th>Đơn vị</th>
      <th>Thành tích</th>
      <th>Hành động</th>
    </tr>
  </thead>
  <tbody>
  {% for s in students %}
  <tr>
    <td>{{ s.vocotruyenid }}</td>
    <td>{{ s.hovaten }}</td>
    <td>{{ s.namsinh }}</td>
    <td>{{ s.gioitinh }}</td>
    <td>{{ s.capbac }}</td>
    <td>{{ s.trinhdo }}</td>
    <td>
      {% if s.maudai %}
<img src="{{ url_for('static', filename=s.maudai) }}" alt="Màu đai" style="width:50px;height:auto;">
      {% else %}
        -
      {% endif %}
    </td>
    <td>{{ s.donvi }}</td>
    <td>{{ s.thanhtich }}</td>
    <td>
      <!-- Nút sửa -->
      <button type="button" class="btn btn-warning btn-sm" data-bs-toggle="modal" data-bs-target="#editStudentModal{{ s.vocotruyenid }}">
        Sửa
      </button>

      <!-- Modal Sửa -->
      <div class="modal fade" id="editStudentModal{{ s.vocotruyenid }}" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title">Sửa Võ Sinh</h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Đóng"></button>
            </div>
            <div class="modal-body">
              <form id="editForm{{ s.vocotruyenid }}" action="{{ url_for('admin_students_update', vocotruyenid=s.vocotruyenid) }}" method="POST">
                <div class="mb-2">
                  <label>Mã số:</label>
                  <input type="text" class="form-control" value="{{ s.vocotruyenid }}" readonly>
                </div>
                <div class="mb-2">
                  <label>Họ và tên:</label>
                  <input type="text" name="hovaten" class="form-control" value="{{ s.hovaten }}">
                </div>
                <div class="mb-2">
                  <label>Năm sinh:</label>
                  <input type="number" name="namsinh" class="form-control" value="{{ s.namsinh }}">
                </div>
                <div class="mb-2">
                  <label>Giới tính:</label>
                  <select name="gioitinh" class="form-control">
                    <option value="">--Chọn--</option>
                    <option value="Nam" {% if s.gioitinh=="Nam" %}selected{% endif %}>Nam</option>
                    <option value="Nữ" {% if s.gioitinh=="Nữ" %}selected{% endif %}>Nữ</option>
                  </select>
                </div>

<div class="mb-2">
  <label for="capbac-{{ s.vocotruyenid }}">Cấp bậc:</label>
  <select name="capbac" id="capbac-{{ s.vocotruyenid }}"
          class="form-control capbac-input" data-target="{{ s.vocotruyenid }}">
    {% for i in range(1, 19) %}
      <option value="{{ i }}" {% if s.capbac|string == i|string %}selected{% endif %}>Cấp {{ i }}</option>
    {% endfor %}
    <option value="Phong tặng" {% if s.capbac == "phong tang" %}selected{% endif %}>Phong tặng</option>
  </select>
</div>

                <div class="mb-2">
                  <label>Trình độ:</label>
                  <input type="text" class="form-control trinhdo-display"
                         id="trinhdo-{{ s.vocotruyenid }}"
                         value="{{ s.trinhdo }}" readonly>
                </div>

                <div class="mb-2">
                  <label>Màu đai:</label><br>
                  <img id="maudai-{{ s.vocotruyenid }}"
src="{{ url_for('static', filename=s.maudai if s.maudai else 'default.jpg') }}"
                       style="width:60px; height:auto;">
                </div>

                <input type="hidden" name="trinhdo" id="hidden-trinhdo-{{ s.vocotruyenid }}" value="{{ s.trinhdo }}">
<input type="hidden" name="maudai" id="hidden-maudai-{{ s.vocotruyenid }}" value="{{ s.maudai }}">

                <div class="mb-2">
                  <label>Đơn vị:</label>
                  <input type="text" name="donvi" class="form-control" value="{{ s.donvi }}">
                </div>
                <div class="mb-2">
                  <label>Thành tích:</label>
                  <input type="text" name="thanhtich" class="form-control" value="{{ s.thanhtich }}">
                </div>
              </form>
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-secondary btn-sm" data-bs-dismiss="modal">Hủy</button>
              <button type="submit" class="btn btn-primary btn-sm" form="editForm{{ s.vocotruyenid }}">Cập nhật</button>
            </div>
          </div>
        </div>
      </div>

      <!-- Nút xóa -->
      <a href="{{ url_for('admin_students_delete', vocotruyenid=s.vocotruyenid) }}"
         class="btn btn-danger btn-sm"
         onclick="return confirm('Bạn có chắc muốn xóa?')">Xóa</a>
    </td>
  </tr>
  {% endfor %}
  </tbody>
</table>

<!-- JS cập nhật trình độ + màu đai -->
<script>
function getTrinhDo(capbac) {
  const s = String(capbac).trim().toLowerCase();

  if (/^\d+$/.test(s)) {
    const n = parseInt(s);
    if (n >= 1 && n <= 8) return "Võ sinh";
    if (n >= 9 && n <= 12) return "Hướng dẫn viên";
    if (n >= 13 && n <= 16) return "Huấn luyện viên";
    if (n === 17) return "Chuẩn võ sư";
    if (n === 18) return "Võ sư";
  }
  if (["phong tang", "phongtang", "phong tặng"].includes(s)) return "Đại võ sư";
  return "Chưa xếp";
}

function getMauDai(capbac) {
  const s = String(capbac).trim().toLowerCase();

  if (/^\d+$/.test(s)) {
    return `/static/cap${s}.jpg`;
  }
  if (["phong tang", "phongtang", "phong tặng"].includes(s)) {
    return `/static/phongtang.jpg`;
  }
  return `/static/default.jpg`;
}

function initCapbacHandlers() {
  document.querySelectorAll(".capbac-input").forEach(el => {
    const handler = function() {
      const id = this.dataset.target;
      const raw = this.value;
      const trinhdo = getTrinhDo(raw);
      const maudai = getMauDai(raw);

      // cập nhật trình độ hiển thị
      const trinhEl = document.getElementById("trinhdo-" + id);
      if (trinhEl) trinhEl.value = trinhdo;

      // cập nhật màu đai hiển thị
      const imgEl = document.getElementById("maudai-" + id);
      if (imgEl) imgEl.src = maudai;

      // cập nhật hidden input
      const hiddenTrinh = document.getElementById("hidden-trinhdo-" + id);
      if (hiddenTrinh) hiddenTrinh.value = trinhdo;

      const hiddenMau = document.getElementById("hidden-maudai-" + id);
      if (hiddenMau) hiddenMau.value = maudai;
    };
    el.addEventListener("change", handler);
    el.addEventListener("input", handler);
  });
}
document.addEventListener("DOMContentLoaded", initCapbacHandlers);
</script>

{% endblock %}
